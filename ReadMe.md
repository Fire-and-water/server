# Сервер для игры Fair & Water +
Сервер состоит из 3 основных частей:
+ http-сервер (обеспечивает всё, что не связано с процессом игры)
+ socket-сервер (обслуживает процесс игры)
+ База данных
## Http-сервер
Здесь будет представлен API для http-сервера. Для многих запросов необходима открытая сессия (открывается при
авторизации: в ответ на запрос авторизации приходит поле cart_session в header ответа, его необходимо
передавать при дальнейших запросов).
### API
Все запросы передаются на сервер http://185.178.47.135:8082

| Смысл                               | Ссылка                                      | Ответ сервера (успешный)        | Нужна открытая сессия? |
|-------------------------------------|---------------------------------------------|---------------------------------|------------------------|
| Регистрация                         | /registerByEmail{nickname, email, password} | {status, msg, id}               | нет                    |
| Авторизация                         | /authByEmail{email, password}               | {status, msg, user}             | нет                    |
| Выход                               | /logout                                     | {status, msg}                   | да                     |
| Свободен ли никнейм                 | /isFreeNickName{nickName}                   | {isFree}                        | нет                    |
| Свободна ли почта                   | /isFreeEmail{email}                         | {isFree}                        | нет                    |
| Смена пароля                        | /changePassword{oldPassword, newPassword}   | {status, msg}                   | да                     |
| Получить топ игроков (топ 10 и id)  | /getTop{id}                                 | [{id, nickname, place, rating}] | нет                    |
| Получить список уровней             | /getLevels                                  | {}                              | да                     |
| Получить карту уровня               | /getLevelById{id}                           | {map}                           | нет                    |
| Получить информацию о себе          | /myInfo                                     | {user}                          | да                     |
| Получить токен для игрового сервера | /getToken                                   | {status, msg, token}            | да                     |
| Получить историю игр                | /getMyHistoryGames                          | [{_}]                           | да                     |
| Получить информацию об игроке       | /userInfo{id}                               | {user}                          | нет                    |
| Принудительно обновить топ*         | /updateTop                                  | -                               | нет                    |
 
`*` - этого здесь быть не должно. Топ обновляется раз в сутки, как в Stepik, например. Но для тестов можно использовать этот запрос

 Почти каждый запрос содержит status. Норма -- `status=1`. Нулевой статус соответствует ошибки авторизации. Во многих 
 неуспешно завершающихся запросах содержится `msg`.  Остальные `status` для каждого запроса имеют разный смысл. Все сопровождаются своим
 `msg`.
 
## Socket - сервер
*Не рекомендуется его тестить, лишь бы поиграться. Можно и в бан улететь.*

Реализован на обычных сокетах. 
### Протокол взаимодействия
1. Подключение: `ip 185.178.47.135 port 1234`.
2. Авторизация игрока: `auth <id> <token>`. (id выдан при регистрации, token -- см. http API)
3. Сервер пришлёт в ответ json со статусом авторизации. Если есть текущая игра сервер сообщит в поле `current-game`
4. Игра
   1. Подключение к текущей игре (если есть `current-game`) - команда `reconnect`
   2. Создание игры `create-game <level> <ROLE>`. Уровень и роль(FIRE/WATER). В ответ придёт идентификатор игры
   3. Присоединение к игре вторым игроком (если есть идентификатор) `connect-to-game <game-id>`
5. После этого сервер может несколько раз прислать json, помеченный полем `what=game-status`. Ждём, когда `isTwoConnected=true` (два игрока подключены)
6. После этого сокет можно ставить на асинхронное слушание/запись и начинать игру.
7. Можно принудительно завершить игру, послав `cancel-game`
## База данных
Живёт на отдельном сервере. Пароль и логин от неё публично выкладывать не хочется.
### best_results
Таблица, хранящая лучшие результаты по игрокам. На её основе перестраивается топ.
### users
В этой таблице хранятся все данные о пользователях, необходимые для авторизации
### levels
Здесь можно хранить информацию об уровнях (несколько полей для его описание, одно поле для json карты)
### top
Сегодняшний рейтинг